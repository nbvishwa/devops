pipeline {
  agent any

  environment {
    DOCKER_COMPOSE_FILE = 'docker-compose.yml'
  }

  options {
    skipDefaultCheckout()
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        sh 'pwd && ls -la'
      }
    }

    stage('Build test-runner image') {
      steps {
        dir('selenium-docker-jenkins-1') {
          sh 'pwd && ls -la'
          sh 'docker build -t selenium-docker-jenkins:test-runner .'
        }
      }
    }

    stage('Start Selenium Grid') {
      steps {
        dir('selenium-docker-jenkins-1') {
          sh 'docker compose -f ${DOCKER_COMPOSE_FILE} up -d selenium-hub chrome firefox edge'
          // wait for hub to be ready
          sh 'echo "Waiting for Selenium Hub..." && sleep 8'
        }
      }
    }

    stage('Run Tests') {
      steps {
        dir('selenium-docker-jenkins-1') {
          // Run tests inside ephemeral container with network access to hub and nodes
          sh 'docker run --rm --network selenium-docker-jenkins-1_default -e GRID_URL=http://selenium-hub:4444 -v $(pwd):/app -w /app selenium-docker-jenkins:test-runner mvn -B test'
        }
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: 'selenium-docker-jenkins-1/target/surefire-reports/junitreports/*.xml'
          archiveArtifacts artifacts: 'selenium-docker-jenkins-1/target/surefire-reports/**/*', allowEmptyArchive: true
          
          // Try to publish HTML report (requires HTML Publisher plugin)
          script {
            try {
              publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'selenium-docker-jenkins-1/target/surefire-reports',
                reportFiles: 'emailable-report.html',
                reportName: 'TestNG Report'
              ])
            } catch (Exception e) {
              echo "HTML Publisher plugin not available: ${e.getMessage()}"
              echo "Install 'HTML Publisher Plugin' to see HTML reports in Jenkins UI"
            }
          }
        }
      }
    }
  }

//   post {
//     always {
//       // Stop and remove grid services
//       sh 'docker compose -f ${DOCKER_COMPOSE_FILE} down -v'
//     }
//   }
}


